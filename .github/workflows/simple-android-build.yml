name: Simple Android APK Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: |
        echo "=== Installing dependencies ==="
        npm install --legacy-peer-deps --force
        echo "=== Dependencies installed ==="

    - name: Update Expo CLI and EAS CLI
      run: |
        echo "=== Updating Expo CLI and EAS CLI ==="
        npm install -g expo-cli@latest eas-cli@latest
        echo "=== CLIs updated ==="

    - name: Check project configuration
      run: |
        echo "=== Checking project configuration ==="
        npx expo doctor
        echo "=== Project configuration checked ==="

    - name: Build Android APK with EAS
      run: |
        echo "=== Building Android APK with EAS ==="
        echo "Project ID: $(npx expo config --get extra.eas.projectId)"
        echo "Using EXPO_TOKEN: $EXPO_TOKEN"
        # Use --no-wait to get build logs immediately (--verbose flag not supported)
        eas build -p android --profile preview --non-interactive --no-wait
        echo "=== APK build started ==="
      env:
        EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

    - name: Wait for build to complete
      run: |
        echo "=== Waiting for build to complete ==="
        # Wait for 5 minutes for the build to complete
        sleep 300
        echo "=== Build waiting completed ==="

    - name: Download latest APK
      run: |
        echo "=== Downloading latest APK ==="
        echo "Using EXPO_TOKEN: $EXPO_TOKEN"
        eas build:download --platform android --latest
        echo "=== APK downloaded ==="
      env:
        EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: "*.apk"
        retention-days: 30
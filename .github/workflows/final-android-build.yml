name: Final Android APK Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: ''

    - name: Install dependencies with detailed logs
      id: install-deps
      run: |
        echo "=== Installing dependencies ==="
        echo "Node.js version: $(node -v)"
        echo "npm version: $(npm -v)"
        echo "Current directory: $(pwd)"
        echo "Package.json exists: $(test -f package.json && echo "Yes" || echo "No")"
        
        if [ -f package.json ]; then
          echo "=== Package.json contents (first 50 lines) ==="
          head -50 package.json
        fi
        
        echo "=== Running npm install ==="
        npm install --legacy-peer-deps --force --verbose 2>&1 | tee npm-install.log
        INSTALL_EXIT_CODE=$?
        
        echo "=== npm install completed with exit code: $INSTALL_EXIT_CODE ==="
        echo "=== npm install log (last 100 lines) ==="
        tail -100 npm-install.log
        
        if [ $INSTALL_EXIT_CODE -ne 0 ]; then
          echo "=== npm install failed, showing full log ==="
          cat npm-install.log
          exit $INSTALL_EXIT_CODE
        fi
        
        echo "=== Dependencies installed successfully ==="
        echo "=== Installed packages (first 20) ==="
        npm list --depth=0 | head -20

    - name: Install EAS CLI
      run: |
        echo "Installing EAS CLI..."
        npm install -g eas-cli
        echo "EAS CLI installed successfully!"
        echo "EAS version: $(eas --version)"

    - name: Test EXPO_TOKEN authentication with --token parameter
      run: |
        echo "Testing EXPO_TOKEN authentication with --token parameter..."
        eas whoami --token ${{ secrets.EXPO_TOKEN }}
        echo "Authentication successful!"

    - name: Build Android APK with --token parameter
      run: |
        echo "Starting Android APK build..."
        echo "Using EXPO_TOKEN with --token parameter"
        eas build -p android --profile preview --non-interactive --token ${{ secrets.EXPO_TOKEN }}
        echo "Build completed!"

    - name: Download APK with --token parameter
      run: |
        echo "Downloading latest APK..."
        echo "Using EXPO_TOKEN with --token parameter"
        eas build:download --platform android --latest --token ${{ secrets.EXPO_TOKEN }}
        echo "APK downloaded successfully!"
        ls -la *.apk

    - name: Upload APK as artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: "*.apk"
        retention-days: 30

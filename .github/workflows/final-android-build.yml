name: Final Android APK Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: ''

    - name: Install dependencies
      run: |
        echo "Installing dependencies..."
        npm install --legacy-peer-deps --force
        echo "Dependencies installed successfully!"

    - name: Install EAS CLI
      run: |
        echo "Installing EAS CLI..."
        npm install -g eas-cli
        echo "EAS CLI installed successfully!"
        echo "EAS version: $(eas --version)"

    - name: Test EXPO_TOKEN authentication with --token parameter
      run: |
        echo "Testing EXPO_TOKEN authentication with --token parameter..."
        eas whoami --token ${{ secrets.EXPO_TOKEN }}
        echo "Authentication successful!"

    - name: Build Android APK with --token parameter
      run: |
        echo "Starting Android APK build..."
        echo "Using EXPO_TOKEN with --token parameter"
        eas build -p android --profile preview --non-interactive --token ${{ secrets.EXPO_TOKEN }}
        echo "Build completed!"

    - name: Download APK with --token parameter
      run: |
        echo "Downloading latest APK..."
        echo "Using EXPO_TOKEN with --token parameter"
        eas build:download --platform android --latest --token ${{ secrets.EXPO_TOKEN }}
        echo "APK downloaded successfully!"
        ls -la *.apk

    - name: Upload APK as artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: "*.apk"
        retention-days: 30

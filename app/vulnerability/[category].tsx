import { ScrollView, Text, View, TouchableOpacity } from "react-native";
import { useLocalSearchParams, router } from "expo-router";
import * as Haptics from "expo-haptics";

import { ScreenContainer } from "@/components/screen-container";
import { IconSymbol } from "@/components/ui/icon-symbol";
import { useColors } from "@/hooks/use-colors";
import { vulnerabilityCategories } from "@/data/vulnerabilities";
import { cn } from "@/lib/utils";

export default function VulnerabilityCategoryScreen() {
  const { category } = useLocalSearchParams<{ category: string }>();
  const colors = useColors();
  
  const categoryData = vulnerabilityCategories.find(cat => cat.id === category);
  
  if (!categoryData) {
    return (
      <ScreenContainer className="items-center justify-center">
        <Text className="text-foreground">åˆ†ç±»ä¸å­˜åœ¨</Text>
      </ScreenContainer>
    );
  }

  const getSeverityColor = (severity: string) => {
    switch (severity) {
      case "critical": return colors.error;
      case "high": return "#FF6B6B";
      case "medium": return colors.warning;
      case "low": return colors.info;
      default: return colors.muted;
    }
  };

  const getSeverityLabel = (severity: string) => {
    switch (severity) {
      case "critical": return "ä¸¥é‡";
      case "high": return "é«˜å±";
      case "medium": return "ä¸­å±";
      case "low": return "ä½å±";
      default: return "æœªçŸ¥";
    }
  };

  const handleVulnerabilityPress = (vulnId: string) => {
    Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
    router.push(`/vulnerability/detail/${vulnId}`);
  };

  const handleBack = () => {
    Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
    router.back();
  };

  return (
    <ScreenContainer className="bg-background">
      {/* Header */}
      <View className="px-4 py-3 border-b border-border flex-row items-center gap-3">
        <TouchableOpacity onPress={handleBack} activeOpacity={0.7}>
          <View className="w-10 h-10 rounded-full bg-surface items-center justify-center">
            <IconSymbol name="chevron.left" size={20} color={colors.foreground} />
          </View>
        </TouchableOpacity>
        <View className="flex-1">
          <Text className="text-xl font-bold text-foreground">{categoryData.name}</Text>
          <Text className="text-sm text-muted">{categoryData.totalCount} ä¸ªæ¼æ´</Text>
        </View>
      </View>

      <ScrollView 
        className="flex-1"
        contentContainerStyle={{ padding: 16, gap: 12 }}
        showsVerticalScrollIndicator={false}
      >
        {/* Category Description */}
        <View className="bg-surface rounded-2xl p-4 border border-border">
          <Text className="text-sm text-foreground leading-relaxed">
            {categoryData.description}
          </Text>
        </View>

        {/* Vulnerability List */}
        {categoryData.vulnerabilities.length === 0 ? (
          <View className="bg-surface rounded-2xl p-8 border border-border items-center">
            <Text className="text-muted text-center">
              æ­¤æ¨¡å—æš‚æ— æ¼æ´æ•°æ®{"\n"}æ•¬è¯·æœŸå¾…
            </Text>
          </View>
        ) : (
          categoryData.vulnerabilities.map((vuln) => (
            <TouchableOpacity
              key={vuln.id}
              onPress={() => handleVulnerabilityPress(vuln.id)}
              activeOpacity={0.7}
            >
              <View className="bg-surface rounded-2xl p-4 border border-border">
                {/* Header */}
                <View className="flex-row items-start justify-between mb-2">
                  <View className="flex-1 pr-3">
                    <Text className="text-base font-semibold text-foreground mb-1">
                      {vuln.title}
                    </Text>
                    <Text className="text-xs text-muted font-mono">
                      {vuln.cveId}
                    </Text>
                  </View>
                  <View 
                    className="px-2 py-1 rounded-full"
                    style={{ backgroundColor: getSeverityColor(vuln.severity) + "20" }}
                  >
                    <Text 
                      className="text-xs font-medium"
                      style={{ color: getSeverityColor(vuln.severity) }}
                    >
                      {getSeverityLabel(vuln.severity)}
                    </Text>
                  </View>
                </View>

                {/* Description */}
                <Text className="text-sm text-foreground leading-relaxed mb-3">
                  {vuln.description}
                </Text>

                {/* File Path */}
                {vuln.filePath && (
                  <View className="bg-background rounded-lg p-2 mb-2">
                    <Text className="text-xs text-muted font-mono">
                      ğŸ“ {vuln.filePath}
                    </Text>
                  </View>
                )}

                {/* Impact Tags */}
                <View className="flex-row flex-wrap gap-2">
                  {vuln.impact.slice(0, 3).map((impact, index) => (
                    <View 
                      key={index}
                      className="px-2 py-1 rounded-full bg-error/10"
                    >
                      <Text className="text-xs text-error">
                        {impact}
                      </Text>
                    </View>
                  ))}
                  {vuln.impact.length > 3 && (
                    <View className="px-2 py-1 rounded-full bg-muted/20">
                      <Text className="text-xs text-muted">
                        +{vuln.impact.length - 3}
                      </Text>
                    </View>
                  )}
                </View>

                {/* View Details Arrow */}
                <View className="flex-row items-center justify-end mt-3 pt-3 border-t border-border">
                  <Text className="text-sm text-primary font-medium mr-1">
                    æŸ¥çœ‹è¯¦æƒ…
                  </Text>
                  <IconSymbol name="chevron.right" size={16} color={colors.primary} />
                </View>
              </View>
            </TouchableOpacity>
          ))
        )}

        {/* Bottom Spacing */}
        <View className="h-4" />
      </ScrollView>
    </ScreenContainer>
  );
}

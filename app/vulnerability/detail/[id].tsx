import { ScrollView, Text, View, TouchableOpacity } from "react-native";
import { useLocalSearchParams, router } from "expo-router";
import * as Haptics from "expo-haptics";

import { ScreenContainer } from "@/components/screen-container";
import { IconSymbol } from "@/components/ui/icon-symbol";
import { useColors } from "@/hooks/use-colors";
import { allVulnerabilities } from "@/data/vulnerabilities";
import { cn } from "@/lib/utils";

export default function VulnerabilityDetailScreen() {
  const { id } = useLocalSearchParams<{ id: string }>();
  const colors = useColors();
  
  const vulnerability = allVulnerabilities.find(v => v.id === id);
  
  if (!vulnerability) {
    return (
      <ScreenContainer className="items-center justify-center">
        <Text className="text-foreground">æ¼æ´ä¸å­˜åœ¨</Text>
      </ScreenContainer>
    );
  }

  const getSeverityColor = (severity: string) => {
    switch (severity) {
      case "critical": return colors.error;
      case "high": return "#FF6B6B";
      case "medium": return colors.warning;
      case "low": return colors.info;
      default: return colors.muted;
    }
  };

  const getSeverityLabel = (severity: string) => {
    switch (severity) {
      case "critical": return "ä¸¥é‡";
      case "high": return "é«˜å±";
      case "medium": return "ä¸­å±";
      case "low": return "ä½å±";
      default: return "æœªçŸ¥";
    }
  };

  const getDifficultyLabel = (difficulty: string) => {
    switch (difficulty) {
      case "easy": return "ç®€å•";
      case "medium": return "ä¸­ç­‰";
      case "hard": return "å›°éš¾";
      default: return "æœªçŸ¥";
    }
  };

  const getDifficultyColor = (difficulty: string) => {
    switch (difficulty) {
      case "easy": return colors.success;
      case "medium": return colors.warning;
      case "hard": return colors.error;
      default: return colors.muted;
    }
  };

  const handleBack = () => {
    Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
    router.back();
  };

  return (
    <ScreenContainer className="bg-background">
      {/* Header */}
      <View className="px-4 py-3 border-b border-border flex-row items-center gap-3">
        <TouchableOpacity onPress={handleBack} activeOpacity={0.7}>
          <View className="w-10 h-10 rounded-full bg-surface items-center justify-center">
            <IconSymbol name="chevron.left" size={20} color={colors.foreground} />
          </View>
        </TouchableOpacity>
        <View className="flex-1">
          <Text className="text-lg font-bold text-foreground">æ¼æ´è¯¦æƒ…</Text>
        </View>
      </View>

      <ScrollView 
        className="flex-1"
        contentContainerStyle={{ padding: 16, gap: 16 }}
        showsVerticalScrollIndicator={false}
      >
        {/* Title and Severity */}
        <View className="gap-3">
          <View className="flex-row items-start justify-between">
            <Text className="text-2xl font-bold text-foreground flex-1 pr-3">
              {vulnerability.title}
            </Text>
            <View 
              className="px-3 py-1 rounded-full"
              style={{ backgroundColor: getSeverityColor(vulnerability.severity) + "20" }}
            >
              <Text 
                className="text-sm font-semibold"
                style={{ color: getSeverityColor(vulnerability.severity) }}
              >
                {getSeverityLabel(vulnerability.severity)}
              </Text>
            </View>
          </View>
          <Text className="text-sm text-muted font-mono">
            {vulnerability.cveId}
          </Text>
        </View>

        {/* Description */}
        <View className="bg-surface rounded-2xl p-4 border border-border">
          <Text className="text-base font-semibold text-foreground mb-2">
            ğŸ“‹ æ¼æ´æè¿°
          </Text>
          <Text className="text-sm text-foreground leading-relaxed">
            {vulnerability.description}
          </Text>
        </View>

        {/* File Location */}
        {vulnerability.filePath && (
          <View className="bg-surface rounded-2xl p-4 border border-border">
            <Text className="text-base font-semibold text-foreground mb-2">
              ğŸ“ æ–‡ä»¶ä½ç½®
            </Text>
            <View className="bg-background rounded-lg p-3">
              <Text className="text-sm text-foreground font-mono">
                {vulnerability.filePath}
              </Text>
              {vulnerability.lineNumber && (
                <Text className="text-xs text-muted mt-1">
                  è¡Œå·: {vulnerability.lineNumber}
                </Text>
              )}
            </View>
          </View>
        )}

        {/* Code Snippet */}
        {vulnerability.codeSnippet && (
          <View className="bg-surface rounded-2xl p-4 border border-border">
            <Text className="text-base font-semibold text-foreground mb-2">
              ğŸ’» ä»£ç ç‰‡æ®µ
            </Text>
            <ScrollView 
              horizontal 
              showsHorizontalScrollIndicator={false}
              className="bg-background rounded-lg p-3"
            >
              <Text className="text-xs text-foreground font-mono leading-relaxed">
                {vulnerability.codeSnippet}
              </Text>
            </ScrollView>
          </View>
        )}

        {/* Impact */}
        <View className="bg-surface rounded-2xl p-4 border border-border">
          <Text className="text-base font-semibold text-foreground mb-3">
            âš ï¸ å½±å“èŒƒå›´
          </Text>
          <View className="gap-2">
            {vulnerability.impact.map((impact, index) => (
              <View key={index} className="flex-row items-start gap-2">
                <Text className="text-error text-sm">â€¢</Text>
                <Text className="text-sm text-foreground flex-1 leading-relaxed">
                  {impact}
                </Text>
              </View>
            ))}
          </View>
        </View>

        {/* Exploitation */}
        <View className="bg-surface rounded-2xl p-4 border border-border">
          <View className="flex-row items-center justify-between mb-3">
            <Text className="text-base font-semibold text-foreground">
              ğŸ¯ åˆ©ç”¨æ–¹æ³•
            </Text>
            <View 
              className="px-2 py-1 rounded-full"
              style={{ backgroundColor: getDifficultyColor(vulnerability.exploitation.difficulty) + "20" }}
            >
              <Text 
                className="text-xs font-medium"
                style={{ color: getDifficultyColor(vulnerability.exploitation.difficulty) }}
              >
                éš¾åº¦: {getDifficultyLabel(vulnerability.exploitation.difficulty)}
              </Text>
            </View>
          </View>

          {/* Requirements */}
          <Text className="text-sm font-semibold text-foreground mb-2">
            å‰ç½®æ¡ä»¶:
          </Text>
          <View className="gap-2 mb-4">
            {vulnerability.exploitation.requirements.map((req, index) => (
              <View key={index} className="flex-row items-start gap-2">
                <Text className="text-accent text-sm">âœ“</Text>
                <Text className="text-sm text-foreground flex-1 leading-relaxed">
                  {req}
                </Text>
              </View>
            ))}
          </View>

          {/* Steps */}
          <Text className="text-sm font-semibold text-foreground mb-2">
            åˆ©ç”¨æ­¥éª¤:
          </Text>
          <View className="gap-2 mb-4">
            {vulnerability.exploitation.steps.map((step, index) => (
              <View key={index} className="bg-background rounded-lg p-3">
                <Text className="text-sm text-foreground leading-relaxed">
                  {step}
                </Text>
              </View>
            ))}
          </View>

          {/* Tools */}
          {vulnerability.exploitation.toolsNeeded && (
            <>
              <Text className="text-sm font-semibold text-foreground mb-2">
                æ‰€éœ€å·¥å…·:
              </Text>
              <View className="flex-row flex-wrap gap-2">
                {vulnerability.exploitation.toolsNeeded.map((tool, index) => (
                  <View 
                    key={index}
                    className="px-3 py-1 rounded-full bg-info/10"
                  >
                    <Text className="text-xs text-info font-medium">
                      {tool}
                    </Text>
                  </View>
                ))}
              </View>
            </>
          )}
        </View>

        {/* Fix */}
        <View className="bg-surface rounded-2xl p-4 border border-border">
          <Text className="text-base font-semibold text-foreground mb-3">
            ğŸ”§ ä¿®å¤æ–¹æ¡ˆ
          </Text>

          {/* Summary */}
          <View className="bg-success/10 rounded-lg p-3 mb-4">
            <Text className="text-sm text-success font-medium leading-relaxed">
              {vulnerability.fix.summary}
            </Text>
          </View>

          {/* Steps */}
          <Text className="text-sm font-semibold text-foreground mb-2">
            ä¿®å¤æ­¥éª¤:
          </Text>
          <View className="gap-2 mb-4">
            {vulnerability.fix.steps.map((step, index) => (
              <View key={index} className="flex-row items-start gap-2">
                <View 
                  className="w-6 h-6 rounded-full items-center justify-center mt-0.5"
                  style={{ backgroundColor: colors.success + "20" }}
                >
                  <Text className="text-xs text-success font-semibold">
                    {index + 1}
                  </Text>
                </View>
                <Text className="text-sm text-foreground flex-1 leading-relaxed">
                  {step}
                </Text>
              </View>
            ))}
          </View>

          {/* Code Example */}
          {vulnerability.fix.codeExample && (
            <>
              <Text className="text-sm font-semibold text-foreground mb-2">
                ä»£ç ç¤ºä¾‹:
              </Text>
              <ScrollView 
                horizontal 
                showsHorizontalScrollIndicator={false}
                className="bg-background rounded-lg p-3"
              >
                <Text className="text-xs text-success font-mono leading-relaxed">
                  {vulnerability.fix.codeExample}
                </Text>
              </ScrollView>
            </>
          )}
        </View>

        {/* Educational Notice */}
        <View className="bg-warning/10 rounded-2xl p-4 border border-warning">
          <View className="flex-row items-start gap-2">
            <IconSymbol name="exclamationmark.triangle" size={20} color={colors.warning} />
            <View className="flex-1">
              <Text className="text-sm font-semibold text-warning mb-1">
                æ•™è‚²ç”¨é€”å£°æ˜
              </Text>
              <Text className="text-xs text-foreground leading-relaxed">
                æœ¬å†…å®¹ä»…ç”¨äºæ•™è‚²å’Œå®‰å…¨ç ”ç©¶ç›®çš„ã€‚è¯·å‹¿å°†è¿™äº›æŠ€æœ¯ç”¨äºæœªæˆæƒçš„æµ‹è¯•æˆ–æ”»å‡»ã€‚ä½¿ç”¨è€…éœ€è‡ªè¡Œæ‰¿æ‹…æ‰€æœ‰æ³•å¾‹è´£ä»»ã€‚
              </Text>
            </View>
          </View>
        </View>

        {/* Bottom Spacing */}
        <View className="h-4" />
      </ScrollView>
    </ScreenContainer>
  );
}

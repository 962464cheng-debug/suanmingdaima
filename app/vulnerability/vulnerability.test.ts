import { describe, it, expect } from "vitest";
import { vulnerabilityCategories, allVulnerabilities } from "@/data/vulnerabilities";

describe("漏洞数据库", () => {
  it("应该包含8个功能分类", () => {
    expect(vulnerabilityCategories).toHaveLength(8);
    
    const categoryIds = vulnerabilityCategories.map(cat => cat.id);
    expect(categoryIds).toContain("network");
    expect(categoryIds).toContain("credential");
    expect(categoryIds).toContain("component");
    expect(categoryIds).toContain("data");
    expect(categoryIds).toContain("permission");
    expect(categoryIds).toContain("payment");
    expect(categoryIds).toContain("script");
    expect(categoryIds).toContain("log");
  });

  it("应该包含至少10个漏洞详情", () => {
    expect(allVulnerabilities.length).toBeGreaterThanOrEqual(10);
    expect(allVulnerabilities.length).toBe(11);
  });

  it("网络监控分类应该包含4个漏洞", () => {
    const networkCategory = vulnerabilityCategories.find(cat => cat.id === "network");
    expect(networkCategory).toBeDefined();
    expect(networkCategory?.vulnerabilities).toHaveLength(4);
  });

  it("每个漏洞应该包含完整的教学内容", () => {
    const firstVuln = allVulnerabilities[0];
    
    // 基本信息
    expect(firstVuln.id).toBeDefined();
    expect(firstVuln.cveId).toBeDefined();
    expect(firstVuln.title).toBeDefined();
    expect(firstVuln.severity).toBeDefined();
    expect(firstVuln.description).toBeDefined();
    
    // 影响范围
    expect(firstVuln.impact).toBeDefined();
    expect(firstVuln.impact.length).toBeGreaterThan(0);
    
    // 利用方法
    expect(firstVuln.exploitation).toBeDefined();
    expect(firstVuln.exploitation.difficulty).toBeDefined();
    expect(firstVuln.exploitation.requirements).toBeDefined();
    expect(firstVuln.exploitation.steps).toBeDefined();
    expect(firstVuln.exploitation.steps.length).toBeGreaterThan(0);
    
    // 修复方案
    expect(firstVuln.fix).toBeDefined();
    expect(firstVuln.fix.summary).toBeDefined();
    expect(firstVuln.fix.steps).toBeDefined();
    expect(firstVuln.fix.steps.length).toBeGreaterThan(0);
  });

  it("应该包含真实的硬编码凭证漏洞", () => {
    const credCategory = vulnerabilityCategories.find(cat => cat.id === "credential");
    expect(credCategory).toBeDefined();
    
    const amapKeyVuln = credCategory?.vulnerabilities.find(v => v.id === "cred-001");
    expect(amapKeyVuln).toBeDefined();
    expect(amapKeyVuln?.title).toContain("高德地图");
    expect(amapKeyVuln?.codeSnippet).toContain("fc7c3d5a76f14ff65fe84d8effdb0545");
  });

  it("支付漏洞应该标记为严重级别", () => {
    const paymentCategory = vulnerabilityCategories.find(cat => cat.id === "payment");
    expect(paymentCategory).toBeDefined();
    
    const paymentVuln = paymentCategory?.vulnerabilities[0];
    expect(paymentVuln?.severity).toBe("critical");
  });

  it("每个漏洞应该有CVE编号", () => {
    allVulnerabilities.forEach(vuln => {
      expect(vuln.cveId).toMatch(/^CVE-/);
    });
  });

  it("利用难度应该是有效值", () => {
    const validDifficulties = ["easy", "medium", "hard"];
    allVulnerabilities.forEach(vuln => {
      expect(validDifficulties).toContain(vuln.exploitation.difficulty);
    });
  });

  it("严重程度应该是有效值", () => {
    const validSeverities = ["critical", "high", "medium", "low"];
    allVulnerabilities.forEach(vuln => {
      expect(validSeverities).toContain(vuln.severity);
    });
  });
});
